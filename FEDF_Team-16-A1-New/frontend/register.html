<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Join Cosmic DevSpace</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/styles.css">
  <link rel="stylesheet" href="./css/navbar.css">
  <link rel="stylesheet" href="./css/auth.css">
</head>
<body class="auth-page register-page">
  <nav class="navbar">
    <div class="navbar-logo">
      <a href="index.html">ğŸš€ Cosmic DevSpace</a>
    </div>
    <ul class="navbar-menu">
      <li><a href="index.html" class="nav-link">Home</a></li>
      <li><a href="portfolio.html" class="nav-link">Portfolio</a></li>
      <li><a href="projects.html" class="nav-link">Projects</a></li>
      <li><a href="blog.html" class="nav-link">Blog</a></li>
      <li><a href="guestbook.html" class="nav-link">Guestbook</a></li>
      <li><a href="analytics.html" class="nav-link">Analytics</a></li>
      <li><a href="contact.html" class="nav-link">Contact</a></li>
    </ul>
    <div class="navbar-auth" id="authLoggedOut">
      <a href="login.html" class="nav-link">Sign In</a>
      <a href="register.html" class="btn-register">Register</a>
    </div>
    <div class="navbar-user" id="authLoggedIn" style="display: none;">
      <span class="user-greeting">Hi, <span id="userName">User</span></span>
      <div class="user-menu">
        <img id="userAvatar" src="" alt="Avatar" class="user-avatar">
        <div class="dropdown-menu">
          <a href="profile.html">ğŸ‘¤ Profile</a>
          <a href="admin.html" id="adminLink" style="display: none;">âš™ï¸ Admin</a>
          <a href="settings.html">âš™ï¸ Settings</a>
          <a href="#" id="logoutBtn">ğŸšª Logout</a>
        </div>
      </div>
    </div>
    <div class="hamburger" id="hamburger">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </nav>

  <div class="orb orb1"></div>
  <div class="orb orb2"></div>
  <div class="orb orb3"></div>
  <div class="orb orb4"></div>

  <section class="auth-hero">
    <div class="hero-content">
      <span class="hero-kicker">Sign Up</span>
      <h1 class="hero-title">Join the Cosmic Adventure!</h1>
      <p class="hero-subtitle">Create your account and become part of the digital universe.</p>
    </div>
  </section>

  <main class="auth-container">
    <div class="auth-card">
      <div class="error-message" id="errorMessage"></div>
      <div class="success-message" id="successMessage"></div>

      <form id="registerForm" class="auth-form">
        <div class="form-group">
          <label for="displayName">Display Name<span class="required">*</span></label>
          <input type="text" id="displayName" name="displayName" placeholder="John Doe" required maxlength="50">
          <div class="field-error" id="displayNameError"></div>
        </div>

        <div class="form-group">
          <label for="email">Email<span class="required">*</span></label>
          <input type="email" id="email" name="email" placeholder="john@example.com" required autocomplete="email">
          <div class="field-error" id="emailError"></div>
        </div>

        <div class="form-group">
          <label for="password">Password<span class="required">*</span></label>
          <div class="password-field">
            <input type="password" id="password" name="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required minlength="8">
            <button type="button" class="password-toggle" onclick="togglePassword('password')" aria-label="Toggle password visibility">ğŸ‘ï¸</button>
          </div>
          <small class="form-helper">Min 8 chars, 1 uppercase, 1 number, 1 special char</small>
          <div class="password-strength">
            <div class="strength-bar">
              <div class="strength-bar-fill" id="strengthBar"></div>
            </div>
            <span class="strength-text" id="strengthText"></span>
          </div>
          <div class="field-error" id="passwordError"></div>
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirm Password<span class="required">*</span></label>
          <div class="password-field">
            <input type="password" id="confirmPassword" name="confirmPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
            <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')" aria-label="Toggle password visibility">ğŸ‘ï¸</button>
          </div>
          <div class="field-error" id="confirmPasswordError"></div>
        </div>

        <div class="checkbox-group">
          <label>
            <input type="checkbox" id="terms" name="terms" required>
            <span>I agree to the <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a></span>
          </label>
        </div>

        <button type="submit" id="submitBtn">
          <span>Create Account</span>
        </button>
      </form>

      <div class="auth-divider">
        <span>OR</span>
      </div>

      <button type="button" class="google-btn" id="googleSignInBtn">
        <svg class="google-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
          <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
          <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
          <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
        </svg>
        <span>Sign up with Google</span>
      </button>

      <div class="auth-links">
        <span>Already have an account? <a href="login.html">Sign in here!</a></span>
        <a href="index.html">â† Back to Home</a>
      </div>
    </div>
  </main>

  <footer class="site-footer auth-footer">
    Â© 2025 Cosmic DevSpace â€¢ Crafted with ğŸŒŒ
  </footer>

  <script src="./js/config.js?v=20251107"></script>
  <script src="./js/api-client.js?v=20251107"></script>
  <script src="./js/app.js?v=20251107"></script>
  <script>
    window.onerror = function(msg, url, lineNo, columnNo, error) {
      console.error('ğŸ”´ Global Error:', msg, 'at', url, lineNo, columnNo);
      const submitBtn = document.getElementById('submitBtn');
      if (submitBtn && submitBtn.disabled) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span>Create Account</span>';
      }
      return false;
    };

    function togglePassword(id) {
      const input = document.getElementById(id);
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    const passwordInput = document.getElementById('password');
    const strengthBar = document.getElementById('strengthBar');
    const strengthText = document.getElementById('strengthText');

    passwordInput.addEventListener('input', () => {
      const password = passwordInput.value;
      let strength = 0;

      if (password.length >= 8) strength++;
      if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
      if (password.match(/[0-9]/)) strength++;
      if (password.match(/[!@#$%^&*]/)) strength++;
      if (password.match(/[^a-zA-Z0-9]/)) strength++;

      strengthBar.className = 'strength-bar-fill';

      if (strength === 0 || strength === 1) {
        strengthBar.classList.add('strength-weak');
        strengthText.textContent = 'Weak password';
        strengthText.style.color = '#ff86b2';
      } else if (strength === 2 || strength === 3) {
        strengthBar.classList.add('strength-medium');
        strengthText.textContent = 'Medium strength';
        strengthText.style.color = '#fde68a';
      } else {
        strengthBar.classList.add('strength-strong');
        strengthText.textContent = 'Strong password!';
        strengthText.style.color = '#4fe8c9';
      }
    });

    function showError(fieldId, message) {
      const input = document.getElementById(fieldId);
      const error = document.getElementById(fieldId + 'Error');
      if (input) {
        input.classList.add('input-error');
      }
      if (error) {
        error.textContent = message;
        error.style.display = 'block';
      }
    }

    function showGlobalError(message) {
      const errorMsg = document.getElementById('errorMessage');
      errorMsg.innerHTML = message;
      errorMsg.style.display = 'block';
    }

    function validateForm() {
      let isValid = true;

      document.querySelectorAll('.field-error').forEach(el => el.style.display = 'none');
      document.querySelectorAll('input').forEach(el => el.classList.remove('input-error'));

      const displayName = document.getElementById('displayName').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const terms = document.getElementById('terms').checked;

      if (displayName.length < 2) {
        showError('displayName', 'Display name must be at least 2 characters');
        isValid = false;
      } else if (displayName.length > 50) {
        showError('displayName', 'Display name must be less than 50 characters');
        isValid = false;
      }

      if (!email) {
        showError('email', 'Email is required');
        isValid = false;
      } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showError('email', 'Please enter a valid email address');
        isValid = false;
      }

      if (password.length < 8) {
        showError('password', 'Password must be at least 8 characters');
        isValid = false;
      } else if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*])/.test(password)) {
        showError('password', 'Password must contain uppercase, lowercase, number, and special character');
        isValid = false;
      }

      if (password !== confirmPassword) {
        showError('confirmPassword', 'Passwords do not match');
        isValid = false;
      }

      if (!terms) {
        showGlobalError('You must accept the Terms of Service and Privacy Policy');
        isValid = false;
      }

      return isValid;
    }

    const registerForm = document.getElementById('registerForm');

    if (!registerForm) {
      console.error('âŒ FATAL: Register form not found!');
    }

    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      console.log('ğŸš€ FORM SUBMITTED!');

      const errorMsg = document.getElementById('errorMessage');
      const successMsg = document.getElementById('successMessage');
      const submitBtn = document.getElementById('submitBtn');

      errorMsg.style.display = 'none';
      successMsg.style.display = 'none';

      if (!validateForm()) {
        console.error('âŒ Form validation failed');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span>Create Account</span>';
        return;
      }

      console.log('âœ… Form validation passed');

      const displayName = document.getElementById('displayName').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      const formData = {
        username: displayName.toLowerCase().replace(/\s+/g, '_'),
        name: displayName,
        email: email,
        password: password,
        confirmPassword: confirmPassword
      };

      console.log('ğŸ“ Form data for API:', {
        username: formData.username,
        name: formData.name,
        email: formData.email,
        password: '***',
        confirmPassword: '***'
      });

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span>Creating account...</span>';

      setTimeout(async () => {
        try {
          console.log('â³ Starting registration process...');
          await new Promise(resolve => setTimeout(resolve, 500));

          if (typeof CosmicAPI !== 'undefined' && CosmicAPI.auth && CosmicAPI.auth.register) {
            console.log('Using real API...');
            try {
              const response = await CosmicAPI.auth.register(formData);
              if (response.success) {
                successMsg.textContent = response.message || 'Account created successfully!';
                successMsg.style.display = 'block';
                document.getElementById('registerForm').reset();
                setTimeout(() => window.location.href = 'login.html', 1500);
              } else {
                throw new Error(response.message || 'Registration failed');
              }
            } catch (apiError) {
              console.error('API Error:', apiError);
              throw apiError;
            }
          } else {
            console.log('ğŸ’¾ Demo mode - no backend connected');

            const userData = {
              name: formData.name,
              email: formData.email.toLowerCase().trim(),
              password: formData.password,
              registeredAt: new Date().toISOString()
            };

            localStorage.setItem('demo_user', JSON.stringify(userData));

            console.log('âœ… User registered successfully!');
            console.log('ğŸ“§ Registered email:', userData.email);
            console.log('ğŸ‘¤ Registered name:', userData.name);
            console.log('ğŸ’¾ Data stored in localStorage');

            successMsg.innerHTML = `
              <strong>âœ… Account Created Successfully!</strong><br>
              <small style="display: block; margin-top: 8px;">ğŸ“§ Email: ${userData.email}</small>
              <small style="display: block; margin-top: 4px;">ğŸ”‘ Password saved securely</small>
              <small style="display: block; margin-top: 8px; color: #fde68a;">â±ï¸ Redirecting to login in 2 seconds...</small>
            `;
            successMsg.style.display = 'block';

            document.getElementById('registerForm').reset();

            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span>Create Account</span>';

            setTimeout(() => {
              console.log('ğŸ”„ Redirecting to login page...');
              window.location.href = 'login.html';
            }, 2000);
          }
        } catch (error) {
          console.error('âŒ Registration error:', error);
          let errorText = error.message || 'Registration failed. Please try again.';

          if (error.errors && Array.isArray(error.errors)) {
            console.log('ğŸ“‹ API Validation Errors:', error.errors);

            error.errors.forEach(err => {
              const field = err.field;
              const message = err.message;

              if (field === 'username') {
                showError('displayName', message);
              } else if (field === 'confirmPassword') {
                showError('confirmPassword', message);
              } else if (field === 'email') {
                showError('email', message);
              } else if (field === 'password') {
                showError('password', message);
              }
            });

            // Check if email or username already exists
            const emailError = error.errors.find(e => e.field === 'email');
            const usernameError = error.errors.find(e => e.field === 'username');
            
            const hasExistingAccount = emailError || usernameError;

            if (hasExistingAccount) {
              errorText = `
                <strong>ğŸš€ Account Already Exists!</strong><br>
                <small style="display: block; margin-top: 8px;">This email or username is already registered in the cosmic database.</small>
                <small style="display: block; margin-top: 12px; font-size: 0.95rem;">
                  âœ¨ <a href="login.html" style="color: #7fd8ff; text-decoration: underline; font-weight: 600;">Sign in here</a> 
                  to access your existing account
                </small>
                <small style="display: block; margin-top: 8px; color: rgba(255,255,255,0.7);">
                  Or use a different email and username to create a new account.
                </small>
              `;
            } else {
              const errorMessages = error.errors.map(e => e.message).join('<br>');
              errorText = `<strong>âš ï¸ Registration Failed:</strong><br><small>${errorMessages}</small>`;
            }
          }

          showGlobalError(errorText);
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<span>Create Account</span>';
        } finally {
          if (submitBtn.disabled && submitBtn.innerHTML.includes('Creating account')) {
            console.log('âš ï¸ Finally block: Resetting button');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span>Create Account</span>';
          }
        }
      }, 100);
    });

    // Google Sign-Up button handler
    document.getElementById('googleSignInBtn').addEventListener('click', () => {
      console.log('ğŸ” Initiating Google OAuth for registration...');
      // Redirect to backend Google OAuth endpoint (same endpoint handles both login and registration)
      window.location.href = '/api/auth/google';
    });
  </script>
  <script src="./js/navbar.js"></script>
</body>
</html>
