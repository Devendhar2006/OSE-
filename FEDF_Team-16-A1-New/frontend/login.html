<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign In - Cosmic DevSpace</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/styles.css">
  <link rel="stylesheet" href="./css/navbar.css">
  <link rel="stylesheet" href="./css/auth.css">
</head>
<body class="auth-page login-page">
  <nav class="navbar">
    <div class="navbar-logo">
      <a href="index.html">üöÄ Cosmic DevSpace</a>
    </div>
    <ul class="navbar-menu">
      <li><a href="index.html" class="nav-link">Home</a></li>
      <li><a href="portfolio.html" class="nav-link">Portfolio</a></li>
      <li><a href="projects.html" class="nav-link">Projects</a></li>
      <li><a href="blog.html" class="nav-link">Blog</a></li>
      <li><a href="guestbook.html" class="nav-link">Guestbook</a></li>
      <li><a href="analytics.html" class="nav-link">Analytics</a></li>
      <li><a href="contact.html" class="nav-link">Contact</a></li>
    </ul>
    <div class="navbar-auth" id="authLoggedOut">
      <a href="login.html" class="nav-link">Sign In</a>
      <a href="register.html" class="btn-register">Register</a>
    </div>
    <div class="navbar-user" id="authLoggedIn" style="display: none;">
      <span class="user-greeting">Hi, <span id="userName">User</span></span>
      <div class="user-menu">
        <img id="userAvatar" src="" alt="Avatar" class="user-avatar">
        <div class="dropdown-menu">
          <a href="profile.html">üë§ Profile</a>
          <a href="admin.html" id="adminLink" style="display: none;">‚öôÔ∏è Admin</a>
          <a href="settings.html">‚öôÔ∏è Settings</a>
          <a href="#" id="logoutBtn">üö™ Logout</a>
        </div>
      </div>
    </div>
    <div class="hamburger" id="hamburger">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </nav>

  <div class="orb orb1"></div>
  <div class="orb orb2"></div>
  <div class="orb orb3"></div>
  <div class="orb orb4"></div>

  <section class="auth-hero">
    <div class="hero-content">
      <span class="hero-kicker">Sign In</span>
      <h1 class="hero-title">Welcome Back to the Cosmos!</h1>
      <p class="hero-subtitle">Sign in to continue your epic journey through the digital universe.</p>
    </div>
  </section>

  <main class="auth-container">
    <div class="auth-card">
      <div class="auth-alert info" id="infoMessage" style="display: none;">
        <span class="alert-icon">‚ÑπÔ∏è</span>
        <div>
          <strong>First time here?</strong> Please register an account first.
        </div>
      </div>

      <div class="error-message" id="errorMessage"></div>
      <div class="success-message" id="successMessage"></div>

      <form id="loginForm" class="auth-form">
        <div class="form-group">
          <label for="email">Email<span class="required">*</span></label>
          <input type="email" id="email" name="email" placeholder="john@example.com" required>
        </div>

        <div class="form-group">
          <label for="password">Password<span class="required">*</span></label>
          <div class="password-field">
            <input type="password" id="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            <button type="button" class="password-toggle" onclick="togglePassword('password')" aria-label="Toggle password visibility">üëÅÔ∏è</button>
          </div>
        </div>

        <div class="remember-row">
          <label>
            <input type="checkbox" id="rememberMe" name="rememberMe">
            Remember me
          </label>
          <a href="#" onclick="alert('Password reset coming soon!'); return false;">Forgot password?</a>
        </div>

        <button type="submit" id="submitBtn">
          <span>Sign In</span>
        </button>
      </form>

      <div class="auth-divider">
        <span>OR</span>
      </div>

      <button type="button" class="google-btn" id="googleSignInBtn">
        <svg class="google-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
          <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
          <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
          <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
        </svg>
        <span>Sign in with Google</span>
      </button>

      <div class="auth-links">
        <span>Don't have an account? <a href="register.html">Create one now!</a></span>
        <a href="index.html">‚Üê Back to Home</a>
      </div>
    </div>
  </main>

  <footer class="site-footer auth-footer">
    ¬© 2025 Cosmic DevSpace ‚Ä¢ Crafted with üåå
  </footer>

  <script src="./js/config.js"></script>
  <script src="./js/api-client.js"></script>
  <script src="./js/app.js"></script>
  <script>
    function togglePassword(id) {
      const input = document.getElementById(id);
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    window.addEventListener('DOMContentLoaded', () => {
      const demoUser = localStorage.getItem('demo_user');
      const infoMessage = document.getElementById('infoMessage');

      if (!demoUser) {
        infoMessage.style.display = 'flex';
        console.log('‚ö†Ô∏è No registered user found. User should register first.');
      } else {
        infoMessage.style.display = 'none';
        const user = JSON.parse(demoUser);
        console.log('‚ÑπÔ∏è Registered user found:', user.email);
      }
    });

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const errorMsg = document.getElementById('errorMessage');
      const successMsg = document.getElementById('successMessage');
      const submitBtn = document.getElementById('submitBtn');

      errorMsg.style.display = 'none';
      successMsg.style.display = 'none';
      document.getElementById('infoMessage').style.display = 'none';

      const emailValue = document.getElementById('email').value.trim();
      const formData = {
        identifier: emailValue,  // Backend expects 'identifier' field
        password: document.getElementById('password').value,
        rememberMe: document.getElementById('rememberMe').checked
      };

      console.log('üìù Login attempt with email:', emailValue);

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span>Signing in...</span>';

      try {
        await new Promise(resolve => setTimeout(resolve, 1000));

        if (typeof CosmicAPI !== 'undefined' && CosmicAPI.auth && CosmicAPI.auth.login) {
          console.log('Using real API for login...');
          try {
            const response = await CosmicAPI.auth.login(formData);

            if (response.success) {
              successMsg.textContent = response.message || 'Login successful!';
              successMsg.style.display = 'block';
              setTimeout(() => window.location.href = 'index.html', 1000);
            } else {
              throw new Error(response.message || 'Login failed');
            }
          } catch (apiError) {
            console.log('API not available, falling back to demo mode...');
          }
        }

        if (!successMsg.style.display || successMsg.style.display === 'none') {
          console.log('Demo mode - checking localStorage...');
          const demoUser = localStorage.getItem('demo_user');

          console.log('Demo user data:', demoUser);

          if (demoUser) {
            const user = JSON.parse(demoUser);
            console.log('üë§ Stored user email:', user.email);
            console.log('üìß Login email:', formData.email);

            const storedEmail = user.email.toLowerCase().trim();
            const loginEmail = emailValue.toLowerCase().trim();

            if (storedEmail === loginEmail) {
              if (user.password && user.password !== formData.password) {
                console.error('‚ùå Password mismatch!');
                throw new Error('‚ùå Invalid password. Please check your password.');
              }

              console.log('‚úÖ Email and password match!');

              successMsg.innerHTML = `
                <strong>‚úÖ Login Successful!</strong><br>
                <small style="display: block; margin-top: 8px;">Welcome back, ${user.name}!</small>
                <small style="display: block; margin-top: 4px;">üîÑ Redirecting to dashboard...</small>
              `;
              successMsg.style.display = 'block';

              localStorage.setItem('cds_user', JSON.stringify({
                name: user.name,
                email: user.email,
                isDemo: true
              }));

              console.log('üéâ Login successful! Session created.');

              if (typeof updateAuthState === 'function') {
                updateAuthState();
              }

              setTimeout(() => {
                console.log('üîÑ Redirecting to home page...');
                window.location.href = 'index.html';
              }, 1500);
            } else {
              console.error('‚ùå Email mismatch!');
              throw new Error('‚ùå Invalid email. Please check your email address.');
            }
          } else {
            console.error('No demo user found in localStorage');
            throw new Error('‚ùå No account found. Please register first or check if you\'re using the same browser.');
          }
        }
      } catch (error) {
        console.error('Login error:', error);
        errorMsg.textContent = error.message || 'Login failed. Please try again.';
        errorMsg.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span>Sign In</span>';
      }
    });

    // Google Sign-In button handler
    document.getElementById('googleSignInBtn').addEventListener('click', () => {
      console.log('üîê Initiating Google OAuth...');
      // Redirect to backend Google OAuth endpoint
      window.location.href = '/api/auth/google';
    });
  </script>
  <script src="./js/navbar.js"></script>
</body>
</html>
